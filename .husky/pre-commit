# Run lint-staged for staged files
echo "ğŸ§¹ Running lint-staged..."
pnpm exec lint-staged

# Check if any TypeScript/JavaScript files are staged
TS_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -n "$TS_JS_FILES" ]; then
  # Run TypeScript type checking only if TS/JS files changed
  echo "ğŸ” Running TypeScript type check..."
  pnpm exec tsc --noEmit

  # Note: Build check moved to CI for faster commits
  echo "ğŸ“¦ Build check will run in CI pipeline"
else
  echo "ğŸ“ Only non-TypeScript files changed, skipping type check"
fi

# Check if any Terraform files are staged
TF_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.tf$' || true)

if [ -n "$TF_FILES" ]; then
  echo "ğŸ—ï¸  Running Terraform checks..."

  # Check if terraform is installed
  if command -v terraform &> /dev/null; then
    # Run terraform validate (requires init, skip if not initialized)
    if [ -d "infrastructure/cloudflare/.terraform" ]; then
      echo "   â†’ terraform validate..."
      (cd infrastructure/cloudflare && terraform validate) || {
        echo "âŒ Terraform validation failed!"
        exit 1
      }
    else
      echo "   â†’ Skipping terraform validate (not initialized locally)"
    fi
  else
    echo "   â†’ Terraform not installed, skipping validate"
  fi

  # Check if tflint is installed
  if command -v tflint &> /dev/null; then
    echo "   â†’ tflint..."
    (cd infrastructure/cloudflare && tflint) || {
      echo "âŒ TFLint found issues!"
      exit 1
    }
  else
    echo "   â†’ TFLint not installed, skipping (install: brew install tflint)"
  fi

  echo "âœ… Terraform checks passed!"
fi

echo "âœ… Pre-commit checks passed!"
