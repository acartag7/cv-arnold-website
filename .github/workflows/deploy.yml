# Deploy Frontend to Cloudflare Workers (via OpenNext)
#
# Trunk-Based Development with Release Tags:
# - Push to main â†’ Deploy to dev (dev-cv.arnoldcartagena.com)
# - Release tag (v*) â†’ Deploy to production (cv.arnoldcartagena.com)
# - Pull request â†’ Temporary preview URL
#
# Manual deployment is also available via workflow_dispatch.

name: Deploy Frontend

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - production
          - dev
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]

jobs:
  deploy:
    # Skip release-please:
    # - PRs from release-please branches (automated changelog updates)
    # - Push to main with release commit message (after merge)
    # But always run for tags (production deploys) and manual triggers
    if: |
      github.event_name == 'workflow_dispatch' ||
      startsWith(github.ref, 'refs/tags/v') ||
      (github.event_name == 'pull_request' && !startsWith(github.head_ref, 'release-please--')) ||
      (github.event_name == 'push' && !contains(github.event.head_commit.message, 'chore(main): release'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      pull-requests: write

    env:
      # Determine environment based on trigger:
      # - Tag (v*) â†’ production
      # - Manual input â†’ as specified
      # - Push to main â†’ dev
      # - PR â†’ dev (for preview)
      DEPLOY_ENV: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) && 'production' || github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js 20.x
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20.x'

      - name: Setup pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
        with:
          version: 9
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Sync CV data from KV
        continue-on-error: true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: pnpm run sync:kv || echo "âš ï¸ KV sync failed, using existing local data"

      - name: Set API URL based on environment
        run: |
          if [ "${{ env.DEPLOY_ENV }}" = "production" ]; then
            echo "API_URL=https://api.arnoldcartagena.com" >> $GITHUB_ENV
          else
            echo "API_URL=https://api-dev.arnoldcartagena.com" >> $GITHUB_ENV
          fi

      - name: Build with OpenNext
        run: pnpm pages:build
        env:
          NEXT_PUBLIC_API_URL: ${{ env.API_URL }}

      - name: Deploy to Production
        if: env.DEPLOY_ENV == 'production' && github.event_name != 'pull_request'
        id: deploy-prod
        uses: cloudflare/wrangler-action@392082e81ffbcb9ebdde27400634aa004b35ea37 # v3.14.1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: '4.54.0'
          command: deploy --config wrangler.pages.toml

      - name: Deploy to Dev
        if: env.DEPLOY_ENV == 'dev' && github.event_name != 'pull_request'
        id: deploy-dev
        uses: cloudflare/wrangler-action@392082e81ffbcb9ebdde27400634aa004b35ea37 # v3.14.1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: '4.54.0'
          command: deploy --config wrangler.pages.toml --env dev

      - name: Deploy Preview (PR)
        if: github.event_name == 'pull_request'
        id: deploy-preview
        uses: cloudflare/wrangler-action@392082e81ffbcb9ebdde27400634aa004b35ea37 # v3.14.1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: '4.54.0'
          command: deploy --config wrangler.pages.toml

      - name: Comment preview URL on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const rawOutput = `${{ steps.deploy-preview.outputs.deployment-url }}`;
            const output = rawOutput.replace(/[<>&"']/g, '');
            const prNumber = context.payload.pull_request.number;
            const isValidUrl = output && output.startsWith('https://');

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('Cloudflare Workers Preview')
            );

            let body;
            if (isValidUrl) {
              body = `## ðŸš€ Cloudflare Workers Preview

            | Name | Link |
            |------|------|
            | Preview URL | ${output} |
            | Latest commit | \`${context.sha.substring(0, 7)}\` |

            ---
            _Deployed with OpenNext + Cloudflare Workers_`;
            } else {
              body = `## âš ï¸ Cloudflare Workers Deployment Issue

            | Name | Status |
            |------|--------|
            | Deployment | Failed or pending |
            | Latest commit | \`${context.sha.substring(0, 7)}\` |

            Please check the [workflow logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.

            ---
            _OpenNext + Cloudflare Workers_`;
            }

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ env.DEPLOY_ENV }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API URL | ${{ env.API_URL }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.DEPLOY_ENV }}" = "production" ]; then
            echo "| Frontend URL | https://cv.arnoldcartagena.com |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Frontend URL | https://dev-cv.arnoldcartagena.com |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "| Release Tag | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          fi
