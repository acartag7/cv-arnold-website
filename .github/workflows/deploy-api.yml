# Deploy API Worker to Cloudflare
#
# Trunk-Based Development with Release Tags:
# - Push to main → Deploy to dev (api-dev.arnoldcartagena.com)
# - Release tag (v*) → Deploy to production (api.arnoldcartagena.com)
#
# Manual deployment is also available via workflow_dispatch.
#
# Note: This workflow deploys src/index.ts using wrangler.toml
# Separate from the frontend (Next.js) deployment.

name: Deploy API Worker

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - production
          - dev
  push:
    branches: [main]
    tags:
      - 'v*'
    # Path filters only affect branch pushes, not tags
    # For tags, GitHub compares the tagged commit which always matches
    paths:
      - 'src/workers/**'
      - 'src/index.ts'
      - 'src/schemas/**'
      - 'src/services/**'
      - 'src/types/**'
      - 'src/lib/**'
      - 'wrangler.toml'
      - '.github/workflows/deploy-api.yml'

jobs:
  deploy-api:
    # Skip release-please merge commits (only changelog/version updates)
    if: |
      github.event_name == 'workflow_dispatch' ||
      startsWith(github.ref, 'refs/tags/v') ||
      !contains(github.event.head_commit.message, 'chore(main): release')
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      # Determine environment based on trigger:
      # - Tag (v*) → production
      # - Manual input → as specified
      # - Push to main → dev
      DEPLOY_ENV: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) && 'production' || github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js 20.x
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20.x'

      - name: Setup pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
        with:
          version: 9
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Deploy API to Production
        if: env.DEPLOY_ENV == 'production'
        uses: cloudflare/wrangler-action@392082e81ffbcb9ebdde27400634aa004b35ea37 # v3.14.1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: '4.54.0'
          command: deploy --config wrangler.toml

      - name: Deploy API to Dev
        if: env.DEPLOY_ENV == 'dev'
        uses: cloudflare/wrangler-action@392082e81ffbcb9ebdde27400634aa004b35ea37 # v3.14.1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: '4.54.0'
          command: deploy --config wrangler.toml --env dev

      - name: Deployment Summary
        run: |
          echo "## API Worker Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ env.DEPLOY_ENV }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.DEPLOY_ENV }}" = "production" ]; then
            echo "| API URL | https://api.arnoldcartagena.com |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| API URL | https://api-dev.arnoldcartagena.com |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "| Release Tag | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          fi
