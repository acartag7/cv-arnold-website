# Cloudflare Workers Configuration - Frontend (Next.js via OpenNext)
# https://opennext.js.org/cloudflare
#
# Enterprise Architecture:
# - Production: cv.arnoldcartagena.com (cv-arnold-website)
# - Dev: dev-cv.arnoldcartagena.com (cv-arnold-website-dev)
#
# Deploy commands:
#   Production: wrangler deploy --config wrangler.pages.toml
#   Dev: wrangler deploy --config wrangler.pages.toml --env dev

name = "cv-arnold-website"
main = ".open-next/worker.js"
compatibility_date = "2025-01-19"
compatibility_flags = ["nodejs_compat", "global_fetch_strictly_public"]

# =============================================================================
# Static Assets (required for OpenNext)
# =============================================================================

[assets]
binding = "ASSETS"
directory = ".open-next/assets"

# =============================================================================
# KV Namespaces (for SSR data fetching)
# =============================================================================
# The frontend worker accesses CV data directly from KV at request time,
# enabling real-time updates when content is changed in the admin CMS.

[[kv_namespaces]]
binding = "CV_DATA"
id = "c9df8a4271984ad8bb0a02c30ff3568d"

# =============================================================================
# Environment Variables
# =============================================================================
# Service token for authenticating with the API (protected by Cloudflare Access)
# These are set via GitHub Secrets and injected during deployment

[vars]
API_URL = "https://api.arnoldcartagena.com"

# =============================================================================
# Service Bindings (Worker-to-Worker communication)
# =============================================================================
# Direct binding to API worker - no HTTP, no Access tokens needed
# The API worker must be deployed before the frontend worker

[[services]]
binding = "API"
service = "cv-arnold-api"

# =============================================================================
# Observability
# =============================================================================

[observability]
enabled = true

# =============================================================================
# Dev Environment
# =============================================================================

[env.dev]
name = "cv-arnold-website-dev"

[env.dev.vars]
API_URL = "https://api-dev.arnoldcartagena.com"

# Dev service binding
[[env.dev.services]]
binding = "API"
service = "cv-arnold-api-dev"

[env.dev.assets]
binding = "ASSETS"
directory = ".open-next/assets"

# Dev KV Namespace (isolated from production)
[[env.dev.kv_namespaces]]
binding = "CV_DATA"
id = "80606d373eff4764b8756c28026fdae9"
